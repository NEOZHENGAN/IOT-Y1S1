/* FILL IN YOUR TEMPLATE INFO HERE */
#define BLYNK_TEMPLATE_ID   "TMPL6fSzjY-CY"
#define BLYNK_TEMPLATE_NAME "Smart Garden Complete"
#define BLYNK_AUTH_TOKEN    "LNI6Szfb9ilZ991T-m6lr-uEkSRcmife"

#define BLYNK_PRINT Serial
#include <WiFi.h>
#include <BlynkSimpleEsp32.h>

char ssid[] = "vivo Y36 5";
char pass[] = "oado200693";

// --- PINS ---
#define PIN_RELAY_LED   26   // Relay 1: Controls Grow Light (Old Pin)
#define PIN_RELAY_PUMP  27   // Relay 2: Controls Water Pump (NEW Pin!)
#define PIN_LDR         34   // LDR Sensor
#define PIN_MOISTURE    35   // Moisture Sensor

// --- SETTINGS ---
int lightThreshold = 2000;   // If < 2000 (Dark) -> Light ON
int dryThreshold = 3000;     // If > 3000 (Dry)  -> Pump ON

// --- VARIABLES ---
bool systemArmed = false;    // Master Switch (Controlled by V2)

// --- RELAY LOGIC ---
// If your relays are Active LOW, leave this as LOW. 
// If your devices turn ON when they should be OFF, swap these.
int RELAY_ON = LOW;      
int RELAY_OFF = HIGH;

BlynkTimer timer;

// --- AUTOMATION LOOP (Runs every 1 second) ---
void myTimerEvent()
{
  // 1. Read Sensors
  int ldrValue = analogRead(PIN_LDR);
  int moistureValue = analogRead(PIN_MOISTURE);

  // 2. Send Data to App
  Blynk.virtualWrite(V0, ldrValue);      // Light Gauge
  Blynk.virtualWrite(V4, moistureValue); // Moisture Gauge

  Serial.print("Light: "); Serial.print(ldrValue);
  Serial.print(" | Soil: "); Serial.println(moistureValue);

  // --- LOGIC ---
  if (systemArmed == true) 
  {
    // === SYSTEM IS ARMED (Active) ===
    
    // JOB A: LIGHT CONTROL
    if (ldrValue < lightThreshold) {
      digitalWrite(PIN_RELAY_LED, RELAY_ON);
      Serial.println(" -> Dark: LED ON");
    } else {
      digitalWrite(PIN_RELAY_LED, RELAY_OFF);
      Serial.println(" -> Bright: LED OFF");
    }

    // JOB B: PUMP CONTROL
    if (moistureValue > dryThreshold) {
      digitalWrite(PIN_RELAY_PUMP, RELAY_ON);
      Serial.println(" -> Soil Dry: PUMP ON");
    } else {
      digitalWrite(PIN_RELAY_PUMP, RELAY_OFF);
      Serial.println(" -> Soil Wet: PUMP OFF");
    }
  } 
  else 
  {
    // === SYSTEM IS DISARMED (Safety OFF) ===
    digitalWrite(PIN_RELAY_LED, RELAY_OFF);
    digitalWrite(PIN_RELAY_PUMP, RELAY_OFF);
    Serial.println(" -> System Disarmed. Everything OFF.");
  }
}

// --- BUTTON V2: MASTER SWITCH ---
BLYNK_WRITE(V2)
{
  int btnValue = param.asInt();
  
  if (btnValue == 1) {
    systemArmed = true;
    Serial.println("SYSTEM ENABLED");
  } else {
    systemArmed = false;
    Serial.println("SYSTEM DISABLED");
  }
}

void setup()
{
  Serial.begin(9600);
  
  // Configure Output Pins (Relays)
  pinMode(PIN_RELAY_LED, OUTPUT);
  pinMode(PIN_RELAY_PUMP, OUTPUT);
  
  // Configure Input Pins (Sensors)
  pinMode(PIN_LDR, INPUT);
  pinMode(PIN_MOISTURE, INPUT);
  
  // Start with everything OFF
  digitalWrite(PIN_RELAY_LED, RELAY_OFF); 
  digitalWrite(PIN_RELAY_PUMP, RELAY_OFF);

  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
  timer.setInterval(1000L, myTimerEvent);
}

void loop()
{
  Blynk.run();
  timer.run();
}
